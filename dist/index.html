<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tauzip</title>
	
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
        }
		h2 {
			display: block;
			font-size: 1.5em;
			margin-block-start: 0.2em;
			margin-block-end: 0.2em;
		}
        .container {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 0 auto;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        .btn-primary {
            background-color: #007acc;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #005a9e;
        }
        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #545b62;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .file-list {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 12px;
        }
        .file-item {
            margin-bottom: 3px;
            padding: 3px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .file-count {
            font-weight: 600;
            color: #007acc;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 2px solid #007acc;
        }
        .warning {
            color: #856404;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 5px;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .status.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .show-folder-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        .show-folder-btn:hover {
            background-color: #218838;
        }
        .debug-info {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 20px;
            font-family: monospace;
        }
        .archive-count {
            font-weight: 600;
            color: #007acc;
        }
        
        /* Progress bar styles for decompression mode */
        .progress-container {
            margin: 20px 0;
        }
        .progress-bar {
            width: 100%;
            height: 24px;
            background-color: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #dee2e6;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 12px;
        }
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            z-index: 1;
            width: 100%;
            text-align: center;
        }
        .status-text {
            text-align: center;
            margin: 10px 0;
            font-size: 14px;
            color: #6c757d;
            min-height: 20px;
        }
        
        /* Mode-specific visibility */
        .compression-mode {
            display: block;
        }
        .decompression-mode {
            display: none;
        }
        .hidden {
            display: none !important;
        }
        
        /* When in decompression mode */
        body.decompress .compression-mode {
            display: none;
        }
        body.decompress .decompression-mode {
            display: block;
        }
        
        /* Cancellation styles */
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .operation-cancelled {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            text-align: center;
        }
    </style>
	
</head>
<body>
    <div class="container">
        <h2 id="pageTitle">TauZip</h2>
        
        <div id="debugInfo" class="debug-info" style="display:none">
            Loading Tauri APIs...
        </div>
        
        <div class="form-group">
            <label id="fileListLabel">Selected Files:</label>
            <div id="fileList" class="file-list">
                <div class="file-item" style="color: #999;">Waiting for file selection...</div>
            </div>
        </div>
        
        <!-- Compression-specific controls -->
        <div class="compression-mode">
            <div class="form-group">
                <label for="outputFile">Output File:</label>
                <input type="text" id="outputFile" placeholder="Enter output filename">
            </div>
            
            <div class="form-group">
                <label for="compressionType">Compression Type:</label>
                <select id="compressionType">
                    <option value="Zip">.zip</option>
                    <option value="TarGz">.tar.gz</option>
                    <option value="TarBr">.tar.br</option>
                    <option value="Gz">.gz</option>
                    <option value="Br">.br</option>
                    <option value="Gzip">.gzip</option>
                    <option value="Bzip2">.bz2</option>
                </select>
                <div id="compressionWarning" class="warning" style="display: none;">
                    Single-file compression formats (.gz, .br, .gzip, .bz2) only support one file at a time.
                </div>
            </div>
        </div>
        
        <!-- Decompression-specific controls -->
        <div class="decompression-mode">
            <div class="progress-container">
                <div class="current-file-label">
                    <label>Current File:</label>
                    <div id="currentFileName" class="current-filename">Ready to start</div>
                </div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill">
                        <div id="progressText" class="progress-text">Ready to start</div>
                    </div>
                </div>
                <div id="statusText" class="status-text">Click "Start Extraction" to begin</div>
            </div>
        </div>
        
        <!-- Progress display for compression mode (hidden by default) -->
        <div class="compression-mode" id="compressionProgress" style="display: none;">
            <div class="progress-container">
                <div class="current-file-label">
                    <label>Current File:</label>
                    <div id="compressionCurrentFile" class="current-filename">Ready to start</div>
                </div>
                <div class="progress-bar">
                    <div id="compressionProgressFill" class="progress-fill">
                        <div id="compressionProgressText" class="progress-text">Ready to start</div>
                    </div>
                </div>
                <div id="compressionStatusText" class="status-text">Click "OK" to begin</div>
            </div>
        </div>
        
        <div class="button-group">
            <button type="button" class="btn-secondary" id="cancelBtn">Cancel</button>
            <button type="button" class="btn-primary compression-mode" id="compressBtn">OK</button>
            <button type="button" class="btn-primary decompression-mode" id="startBtn">Start Extraction</button>
        </div>
        
        <div id="status" class="status"></div>
    </div>

    <script>
        // Global variables
        let selectedFiles = [];
        let selectedArchives = [];
        let tauriAPI = null;
        let lastCompressedFile = null;
        let lastExtractedLocation = null;
        let isExtracting = false;
        let isCompressing = false;
        let currentMode = 'compression'; // 'compression' or 'decompression'
        let operationCancelled = false;
        
        // Initialize Tauri APIs with proper error handling
        function initializeTauriAPIs() {
            try {
                if (window.__TAURI__ && window.__TAURI__.core && window.__TAURI__.window && window.__TAURI__.event) {
                    tauriAPI = {
                        invoke: window.__TAURI__.core.invoke,
                        appWindow: window.__TAURI__.window,
                        listen: window.__TAURI__.event.listen
                    };
                    
                    updateDebugInfo('✓ Tauri APIs loaded successfully');
                    console.log('Tauri APIs initialized:', tauriAPI);
                    
                    // Set up event listeners
                    setupEventListeners();
                    return true;
                } else {
                    throw new Error('Tauri APIs not available');
                }
            } catch (error) {
                console.error('Failed to initialize Tauri APIs:', error);
                updateDebugInfo('✗ Tauri APIs not available - ' + error.message);
                setupFallbackMode();
                return false;
            }
        }
        
        function updateDebugInfo(message) {
            const debugElement = document.getElementById('debugInfo');
            debugElement.textContent = message;
            console.log('Debug:', message);
        }
        
        function setupEventListeners() {
            if (!tauriAPI) return;
            
            // Listen for mode setting
            tauriAPI.listen('set-mode', (event) => {
                console.log('Received set-mode event:', event.payload);
                setMode(event.payload);
            });
            
            // Listen for file selection from the main process (compression mode)
            tauriAPI.listen('files-selected', (event) => {
                console.log('Received files-selected event:', event);
                console.log('Event payload type:', typeof event.payload);
                console.log('Event payload content:', event.payload);
                
                let newFiles = [];

				// Parse the payload
				if (Array.isArray(event.payload)) {
					newFiles = event.payload;
				} else if (event.payload && Array.isArray(event.payload.files)) {
					newFiles = event.payload.files;
				} else {
					newFiles = [event.payload]; 
				}
                
				const filteredFiles = newFiles.filter(f => !selectedFiles.includes(f));
				//const filteredFiles2 = filteredFiles.filter(f => f !== "gui-compress" &&
				//	f !== "gui-decompress"
				//);
				// Append only new files
				selectedFiles.push(...filteredFiles);
                console.log('Selected files set to:', selectedFiles);
                console.log('Number of files:', selectedFiles.length);
                
                updateDebugInfo(`✓ Received ${selectedFiles.length} files`);
                displayFiles();
                if (currentMode === 'compression') {
                    generateDefaultOutputName();
                    updateCompressionWarning();
                }
            });
            
            // Listen for archive selection from the main process (decompression mode)
            tauriAPI.listen('archives-selected', (event) => {
                console.log('Received archives-selected event:', event);
                console.log('Event payload type:', typeof event.payload);
                console.log('Event payload content:', event.payload);
                
				let newArchives = [];
				
                // Ensure we handle the payload correctly
                if (Array.isArray(event.payload)) {
                    newArchives = event.payload;
                } else if (event.payload && Array.isArray(event.payload.files)) {
                    newArchives = event.payload.files;
                } else {
                    newArchives = [event.payload];
                }
				const filteredArchives = newArchives.filter(f => !selectedArchives.includes(f));
				//const filteredArchives2 = filteredArchives.filter(f => f !== "gui-compress" &&
				//	f !== "gui-decompress"
				//);
                selectedArchives.push(...filteredArchives);
                console.log('Selected archives set to:', selectedArchives);
                console.log('Number of archives:', selectedArchives.length);
                
                updateDebugInfo(`✓ Ready to extract ${selectedArchives.length} archive(s)`);
                displayArchives();
                updateDecompressionUI();
            });
            
            // Listen for both compression and decompression progress updates
            tauriAPI.listen('compression-progress', (event) => {
                console.log('Progress update:', event.payload);
                updateProgress(event.payload);
            });
        }
        
        function setMode(mode) {
            currentMode = mode;
            document.body.className = mode === 'decompression' ? 'decompress' : '';
            
            if (mode === 'decompression') {
                document.getElementById('pageTitle').textContent = 'TauZip Decompression';
                document.getElementById('fileListLabel').textContent = 'Archives to Extract:';
                updateDebugInfo('✓ Decompression mode activated');
            } else {
                document.getElementById('pageTitle').textContent = 'TauZip Compression';
                document.getElementById('fileListLabel').textContent = 'Selected Files:';
                updateDebugInfo('✓ Compression mode activated');
            }
        }
        
        function setupFallbackMode() {
            // For testing outside Tauri context
            updateDebugInfo('Running in fallback mode (for testing)');
            if (currentMode === 'decompression') {
                selectedArchives = ['test-archive.zip', 'another-archive.tar.gz'];
                displayArchives();
                updateDecompressionUI();
            } else {
                selectedFiles = ['test-file.txt', 'another-file.pdf', 'third-file.jpg'];
                displayFiles();
                generateDefaultOutputName();
                updateCompressionWarning();
            }
        }
        
        function displayFiles() {
            console.log('Displaying files:', selectedFiles);
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            if (!selectedFiles || selectedFiles.length === 0) {
                fileList.innerHTML = '<div class="file-item" style="color: #999;">No files selected</div>';
                return;
            }
            
            // Add count header
            const countHeader = document.createElement('div');
            countHeader.className = 'file-count';
            countHeader.textContent = `${selectedFiles.length} file(s) selected:`;
            fileList.appendChild(countHeader);
            
            selectedFiles.forEach((file, index) => {
                console.log(`Adding file ${index}: ${file}`);
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                // Extract just the filename from the full path for display
                const fileName = file.split(/[/\\]/).pop();
                fileItem.textContent = `${index + 1}. ${fileName}`;
                fileItem.title = file; // Show full path on hover
                
                fileList.appendChild(fileItem);
            });
        }
        
        function displayArchives() {
            console.log('Displaying archives:', selectedArchives);
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            if (!selectedArchives || selectedArchives.length === 0) {
                fileList.innerHTML = '<div class="file-item" style="color: #999;">No archives selected</div>';
                return;
            }
            
            // Add count header
            const countHeader = document.createElement('div');
            countHeader.className = 'file-count archive-count';
            countHeader.textContent = `${selectedArchives.length} archive(s) selected:`;
            fileList.appendChild(countHeader);
            
            selectedArchives.forEach((archive, index) => {
                console.log(`Adding archive ${index}: ${archive}`);
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                // Extract just the filename from the full path
                const fileName = archive.split(/[/\\]/).pop();
                fileItem.textContent = `${index + 1}. ${fileName}`;
                fileItem.title = archive; // Show full path on hover
                
                fileList.appendChild(fileItem);
            });
        }
        
        function generateDefaultOutputName() {
            console.log('Generating default output name for files:', selectedFiles);
            
            if (!selectedFiles || selectedFiles.length === 0) {
                console.log('No files to generate name from');
                return;
            }
            
            const compressiontype = document.getElementById('compressionType').value.toString();
            const extensions = {
                'Zip': '.zip',
                'TarGz': '.tar.gz',
                'TarBr': '.tar.br',
                'Gz': '.gz',
                'Br': '.br',
                'Gzip': '.gzip',
                'Bzip2': '.bz2'
            };
            
            let baseName;
            let outputDir = '';
            
            if (selectedFiles.length === 1) {
                const filePath = selectedFiles[0];
                const fileName = filePath.split(/[/\\]/).pop();
                baseName = fileName.replace(/\.[^/.]+$/, "");
                
                // Get the directory of the first file
                const pathParts = filePath.split(/[/\\]/);
                pathParts.pop(); // Remove filename
                outputDir = pathParts.join('\\') + '\\'; // Use backslash for Windows
            } else {
                baseName = 'archive';
                
                // Use directory of first file
                const filePath = selectedFiles[0];
                const pathParts = filePath.split(/[/\\]/);
                pathParts.pop(); // Remove filename
                outputDir = pathParts.join('\\') + '\\';
            }
            
            const outputName = baseName + extensions[compressiontype];
            const fullPath = outputDir + outputName;
            
            console.log('Generated output name:', outputName);
            console.log('Full output path:', fullPath);
            
            // Show just the filename in the input, but store the full path info
            document.getElementById('outputFile').value = outputName;
            
            // Update debug info to show where the file will be saved
            updateDebugInfo(`✓ Received ${selectedFiles.length} files - Output will be saved to: ${outputDir}`);
        }
        
        function updateCompressionWarning() {
            const compressiontype = document.getElementById('compressionType').value.toString();
            const warning = document.getElementById('compressionWarning');
            const singleFileFormats = ['Gz', 'Br', 'Gzip', 'Bzip2'];
            
            if (singleFileFormats.includes(compressiontype) && selectedFiles && selectedFiles.length > 1) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }
        
        function updateDecompressionUI() {
            const startBtn = document.getElementById('startBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            if (isExtracting) {
                startBtn.disabled = true;
                startBtn.textContent = 'Extracting...';
                cancelBtn.textContent = 'Cancel';
                cancelBtn.className = 'btn-danger';
                cancelBtn.disabled = false;
            } else {
                startBtn.disabled = !selectedArchives || selectedArchives.length === 0;
                startBtn.textContent = 'Start Extraction';
                cancelBtn.textContent = 'Cancel';
                cancelBtn.className = 'btn-secondary';
                cancelBtn.disabled = false;
            }
        }
        
        function updateProgress(progressData) {
            const isDecompression = currentMode === 'decompression';
            
            // Select the appropriate elements based on mode
            const progressFill = document.getElementById(isDecompression ? 'progressFill' : 'compressionProgressFill');
            const progressText = document.getElementById(isDecompression ? 'progressText' : 'compressionProgressText');
            const statusText = document.getElementById(isDecompression ? 'statusText' : 'compressionStatusText');
            const currentFileElement = document.getElementById(isDecompression ? 'currentFileName' : 'compressionCurrentFile');
            
            const percentage = Math.round(progressData.progress);
            
            // Update progress bar
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${percentage}%`;
            
            // Update current filename
            if (currentFileElement && progressData.current_file) {
                if (progressData.current_file === 'Complete') {
                    currentFileElement.textContent = '✓ All files processed';
                    currentFileElement.style.color = '#28a745';
                } else {
                    currentFileElement.textContent = progressData.current_file;
                    currentFileElement.style.color = '#495057';
                }
            }
            
            // Update status text based on operation
            if (progressData.progress >= 100) {
                if (progressData.operation === 'compressing') {
                    statusText.textContent = 'Compression complete!';
                } else {
                    statusText.textContent = 'Extraction complete!';
                }
            } else if (progressData.current_file && progressData.current_file !== 'Complete') {
                if (progressData.operation === 'compressing') {
                    statusText.textContent = `Compressing file ${progressData.current_file_index || 1} of ${progressData.total_files}...`;
                } else {
                    statusText.textContent = `Extracting archive ${progressData.current_file_index}/${progressData.total_files}...`;
                }
            } else {
                if (progressData.operation === 'compressing') {
                    statusText.textContent = `Processing files...`;
                } else {
                    statusText.textContent = `Processing archive ${progressData.current_file_index}/${progressData.total_files}`;
                }
            }
        }
        
        // Set up UI event listeners
        function setupUIEventListeners() {
            // Compression type change handler
            document.getElementById('compressionType').addEventListener('change', () => {
                generateDefaultOutputName();
                updateCompressionWarning();
            });
            
            // Compress button click handler
            document.getElementById('compressBtn').addEventListener('click', startCompression);
            
            // Extract button click handler
            document.getElementById('startBtn').addEventListener('click', startExtraction);
            
            // Cancel button click handler
            document.getElementById('cancelBtn').addEventListener('click', cancelOperation);
            
            // Enter key in output file field
            document.getElementById('outputFile').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    startCompression();
                }
            });
            
            console.log('UI event listeners set up');
        }
        
        async function startCompression() {
            console.log('Starting compression with files:', selectedFiles);
            
            const outputFile = document.getElementById('outputFile').value.trim();
            const compressiontype = document.getElementById('compressionType').value.toString();
            const status = document.getElementById('status');
            
            if (!outputFile) {
                showStatus('Please enter an output filename.', 'error');
                return;
            }
            
            if (!selectedFiles || selectedFiles.length === 0) {
                showStatus('No files selected for compression.', 'error');
                return;
            }
            
            if (!tauriAPI) {
                showStatus('Tauri APIs not available - running in demo mode', 'error');
                return;
            }
            
            isCompressing = true;
            operationCancelled = false;
            
            // Show progress bar and hide compression form during compression
            const compressionForm = document.querySelectorAll('.compression-mode:not(#compressionProgress)');
            const progressContainer = document.getElementById('compressionProgress');
            
            compressionForm.forEach(el => el.style.display = 'none');
            progressContainer.style.display = 'block';
            hideStatus();
            
            // Reset progress
            updateProgress({
                progress: 0,
                current_file: 'Starting...',
                total_files: selectedFiles.length,
                current_file_index: 1,
                operation: 'compressing'
            });
            
            // Update UI buttons
            const compressBtn = document.getElementById('compressBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            compressBtn.disabled = true;
            compressBtn.textContent = 'Compressing...';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'btn-danger';
            cancelBtn.disabled = false;
            
            try {
                // Validate compression type for multiple files
                const isValid = await tauriAPI.invoke('validate_compression_type', {
                    files: selectedFiles,
                    compressiontype: compressiontype
                });
                
                if (!isValid) {
                    showStatus('Selected compression type does not support multiple files.', 'error');
                    resetCompressionUI(compressionForm, progressContainer, compressBtn, cancelBtn);
                    return;
                }
                
                console.log('Calling compress_files_command with:', {
                    files: selectedFiles,
                    outputfile: outputFile,
                    compressiontype: compressiontype
                });
                
                const result = await tauriAPI.invoke('compress_files_command', {
                    files: selectedFiles,
                    outputfile: outputFile,
                    compressiontype: compressiontype
                });
                
                console.log('Compression result:', result);
                
                if (operationCancelled) {
                    showStatus('Operation was cancelled.', 'error');
                    resetCompressionUI(compressionForm, progressContainer, compressBtn, cancelBtn);
                    return;
                }
                
                // Extract file path from result message
                const pathMatch = result.match(/Files compressed successfully to: (.+)$/);
                if (pathMatch) {
                    lastCompressedFile = pathMatch[1];
                }
                
                // Hide progress bar and show result
                compressionForm.forEach(el => el.style.display = 'block');
                progressContainer.style.display = 'none';
                showStatus(result, 'success', true);
                
                // Close the window after a delay to allow user to see the result
                setTimeout(() => {
                    closeWindow();
                }, 2000);
                
            } catch (error) {
                console.error('Compression error:', error);
                
                if (error.toString().includes('cancelled')) {
                    showStatus('Operation was cancelled.', 'error');
                } else {
                    showStatus(`Compression failed: ${error}`, 'error');
                }
                
                resetCompressionUI(compressionForm, progressContainer, compressBtn, cancelBtn);
            }
        }
        
        function resetCompressionUI(compressionForm, progressContainer, compressBtn, cancelBtn) {
            isCompressing = false;
            compressionForm.forEach(el => el.style.display = 'block');
            progressContainer.style.display = 'none';
            compressBtn.disabled = false;
            compressBtn.textContent = 'OK';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'btn-secondary';
            cancelBtn.disabled = false;
        }
        
        async function startExtraction() {
            console.log('Starting extraction with archives:', selectedArchives);
            
            if (!selectedArchives || selectedArchives.length === 0) {
                showStatus('No archives selected for extraction.', 'error');
                return;
            }
            
            if (!tauriAPI) {
                showStatus('Tauri APIs not available - running in demo mode', 'error');
                return;
            }
            
            isExtracting = true;
            operationCancelled = false;
            updateDecompressionUI();
            hideStatus();
            
            // Reset progress
            updateProgress({
                progress: 0,
                current_file: 'Starting...',
                total_files: selectedArchives.length,
                current_file_index: 0
            });
            
            try {
                console.log('Calling decompress_files_command with:', selectedArchives);
                
                const result = await tauriAPI.invoke('decompress_files_command', {
                    files: selectedArchives
                });
                
                console.log('Extraction result:', result);
                
                if (operationCancelled) {
                    showStatus('Operation was cancelled.', 'error');
                    isExtracting = false;
                    updateDecompressionUI();
                    return;
                }
                
                lastExtractedLocation = result;
                
                showStatus(result, 'success', true);
                
                // Auto-close after 3 seconds
                setTimeout(() => {
                    console.log('Auto-closing window after successful extraction');
                    closeWindow();
                }, 3000);
                
            } catch (error) {
                console.error('Extraction error:', error);
                
                if (error.toString().includes('cancelled')) {
                    showStatus('Operation was cancelled.', 'error');
                } else {
                    showStatus(`Extraction failed: ${error}`, 'error');
                }
                
                isExtracting = false;
                updateDecompressionUI();
            }
        }
        
        function closeWindow() {
            console.log('Attempting to close window...');
            if (tauriAPI && tauriAPI.appWindow) {
                try {
                    //tauriAPI.appWindow.close();
					tauriAPI.invoke("close");
                    console.log('Window close command sent');
                } catch (error) {
                    console.error('Error closing window:', error);
                    // Fallback: try to close via window.close()
                    window.close();
                }
            } else {
                console.log('Tauri window API not available, trying window.close()');
                window.close();
            }
        }
        
        async function cancelOperation() {
            console.log('Cancel button clicked');
            
            if (isExtracting || isCompressing) {
                console.log('Requesting operation cancellation...');
                operationCancelled = true;
                
                try {
                    if (tauriAPI) {
                        await tauriAPI.invoke('cancel_operation');
                        console.log('Cancellation request sent to backend');
                    }
                } catch (error) {
                    console.error('Failed to send cancellation request:', error);
                }
                
                // Update UI immediately
                if (isExtracting) {
                    isExtracting = false;
                    updateDecompressionUI();
                    showStatus('Extraction was cancelled. Any temporary files have been cleaned up.', 'error');
                } else if (isCompressing) {
                    isCompressing = false;
                    const compressionForm = document.querySelectorAll('.compression-mode:not(#compressionProgress)');
                    const progressContainer = document.getElementById('compressionProgress');
                    const compressBtn = document.getElementById('compressBtn');
                    const cancelBtn = document.getElementById('cancelBtn');
                    
                    resetCompressionUI(compressionForm, progressContainer, compressBtn, cancelBtn);
                    showStatus('Compression was cancelled.', 'error');
                }
            } else {
                closeWindow();
            }
        }
        
        function showStatus(message, type, showFolderButton = false) {
            const status = document.getElementById('status');
            status.innerHTML = ''; // Clear previous content
            
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            status.appendChild(messageSpan);
            
            if (showFolderButton && (lastCompressedFile || lastExtractedLocation) && tauriAPI) {
                const folderBtn = document.createElement('button');
                folderBtn.textContent = 'Show in Folder';
                folderBtn.className = 'show-folder-btn';
                folderBtn.addEventListener('click', async () => {
                    try {
                        let pathToOpen = lastCompressedFile;
                        if (currentMode === 'decompression' && lastExtractedLocation) {
                            // Extract the first directory path from the result message
                            const pathMatch = lastExtractedLocation.match(/to: (.+?)(?:\s|$)/);
                            if (pathMatch) {
                                pathToOpen = pathMatch[1];
                            }
                        }
                        await tauriAPI.invoke('open_file_location', pathToOpen);
                    } catch (error) {
                        console.error('Failed to open file location:', error);
                    }
                });
                status.appendChild(folderBtn);
            }
            
            status.className = `status ${type}`;
            status.style.display = 'block';
        }
        
        function hideStatus() {
            const status = document.getElementById('status');
            status.style.display = 'none';
        }
        
		function dom_loaded() {
			// Initialize everything when the page loads
			document.addEventListener('DOMContentLoaded', () => {
				console.log('DOM loaded, initializing...');
				
				// Set up UI event listeners first
				setupUIEventListeners();
				
				// Try to initialize Tauri APIs
				const success = initializeTauriAPIs();
				
				if (!success) {
					// If Tauri APIs aren't available, set up a demo mode
					setTimeout(() => {
						console.log('Setting up demo mode...');
						setupFallbackMode();
					}, 1000);
				}
				
				// Initialize display regardless
				displayFiles();
			});
		}
		
		dom_loaded();
		
        setTimeout(() => {
			const success = initializeTauriAPIs();
		}, 1000);
		
        // Also try initialization on window load as a fallback
        window.addEventListener('load', () => {
            if (!tauriAPI) {
                console.log('Retrying Tauri API initialization...');
                initializeTauriAPIs();
            }
        });
		
		function resizeToFitContent() {
			if (tauriAPI && tauriAPI.appWindow && window.__TAURI__.dpi) { 
			  const { LogicalSize } = window.__TAURI__.dpi;
			  const height = document.body.scrollHeight;
			  const width = document.body.scrollWidth;

			  if (height < 800) {
				 tauriAPI.appWindow.getCurrentWindow().setSize(new LogicalSize(540, height));
			  }
		  }
		}

		// Wait for the DOM to render fully
		window.addEventListener('load', () => {
		  setInterval(resizeToFitContent, 100); // allow layout to settle
		});
    </script>
</body>
</html>